{% extends "base.html" %} {%block content%}
<button
  type="button"
  class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800 uppercase"
  id="test"
>
  Test
</button>
<div
  id="modal_checkin"
  class="hs-overlay hidden size-full fixed top-0 start-0 z-[80] overflow-x-hidden overflow-y-auto pointer-events-none"
>
  <div
    class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-4xl sm:w-full m-3 sm:mx-auto min-h-[calc(100%-3.5rem)] flex items-center"
  >
    <div
      class="w-full max-h-full flex flex-col bg-white border shadow-sm rounded-xl pointer-events-auto dark:bg-neutral-800 dark:border-neutral-700 dark:shadow-neutral-700/70"
    >
      <div
        class="flex justify-between items-center py-3 px-4 border-b dark:border-neutral-700"
      >
        <h3 class="font-bold text-gray-800 dark:text-white">
          <span id="modal_title">Phát hiện biển số xe</span>

          <span
            class="max-w-full ms-2 whitespace-nowrap inline-block py-3 px-3 rounded-lg text-xs font-medium border border-blue-500 text-blue-500 relative"
            id="license_plate_text"
          >
          </span>
        </h3>

        <button
          type="button"
          class="flex justify-center items-center size-7 text-sm font-semibold rounded-full border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none dark:text-white dark:hover:bg-neutral-700"
          data-hs-overlay="#modal_checkin"
        >
          <span class="sr-only">Close</span>
          <svg
            class="flex-shrink-0 size-4"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M18 6 6 18"></path>
            <path d="m6 6 12 12"></path>
          </svg>
        </button>
      </div>
      <div class="p-4 overflow-y-auto">
        <div class="flex flex-col justify-center">
          <!-- Stepper -->
          <div
            id="stepper"
            data-hs-stepper='{
        "currentIndex": 1
        }'
          >
            <!-- Stepper Nav -->
            <ul class="relative flex flex-row gap-x-2">
              <li
                class="flex items-center gap-x-2 shrink basis-0 flex-1 group active"
                data-hs-stepper-nav-item='{
              "index": 1,
              "isCompleted": false
            }'
              >
                <span
                  class="min-w-7 min-h-7 group inline-flex items-center text-xs align-middle"
                >
                  <span
                    class="size-7 flex justify-center items-center flex-shrink-0 bg-gray-100 font-medium text-gray-800 rounded-full group-focus:bg-gray-200 hs-stepper-active:bg-blue-600 hs-stepper-active:text-white hs-stepper-success:bg-blue-600 hs-stepper-success:text-white hs-stepper-completed:bg-teal-500 hs-stepper-completed:group-focus:bg-teal-600 dark:bg-neutral-700 dark:text-white dark:group-focus:bg-gray-600 dark:hs-stepper-active:bg-blue-500 dark:hs-stepper-success:bg-blue-500 dark:hs-stepper-completed:bg-teal-500 dark:hs-stepper-completed:group-focus:bg-teal-600"
                  >
                    <span
                      class="hs-stepper-success:hidden hs-stepper-completed:hidden"
                      >1</span
                    >
                    <svg
                      class="hidden flex-shrink-0 size-3 hs-stepper-success:block"
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </span>
                  <span
                    class="ms-2 text-sm font-medium text-gray-800 dark:text-neutral-200"
                  >
                    Xác nhận thông tin biển số xe
                  </span>
                </span>
                <div
                  class="w-full h-px flex-1 bg-gray-200 group-last:hidden hs-stepper-success:bg-blue-600 hs-stepper-completed:bg-teal-600 dark:bg-neutral-700 dark:hs-stepper-success:bg-blue-600 dark:hs-stepper-completed:bg-teal-600"
                ></div>
              </li>

              <li
                class="flex items-center gap-x-2 shrink basis-0 flex-1 group"
                data-hs-stepper-nav-item='{
              "index": 2
            }'
              >
                <span
                  class="min-w-7 min-h-7 group inline-flex items-center text-xs align-middle"
                >
                  <span
                    class="size-7 flex justify-center items-center flex-shrink-0 bg-gray-100 font-medium text-gray-800 rounded-full group-focus:bg-gray-200 hs-stepper-active:bg-blue-600 hs-stepper-active:text-white hs-stepper-success:bg-blue-600 hs-stepper-success:text-white hs-stepper-completed:bg-teal-500 hs-stepper-completed:group-focus:bg-teal-600 dark:bg-neutral-700 dark:text-white dark:group-focus:bg-gray-600 dark:hs-stepper-active:bg-blue-500 dark:hs-stepper-success:bg-blue-500 dark:hs-stepper-completed:bg-teal-500 dark:hs-stepper-completed:group-focus:bg-teal-600"
                  >
                    <span
                      class="hs-stepper-success:hidden hs-stepper-completed:hidden"
                      >2</span
                    >
                    <svg
                      class="hidden flex-shrink-0 size-3 hs-stepper-success:block"
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </span>
                  <span
                    class="ms-2 text-sm font-medium text-gray-800 dark:text-neutral-200"
                  >
                    Cập nhật thông tin biển số xe
                  </span>
                </span>
                <div
                  class="w-full h-px flex-1 bg-gray-200 group-last:hidden hs-stepper-success:bg-blue-600 hs-stepper-completed:bg-teal-600 dark:bg-neutral-700 dark:hs-stepper-success:bg-blue-600 dark:hs-stepper-completed:bg-teal-600"
                ></div>
              </li>

              <li
                class="flex items-center gap-x-2 shrink basis-0 flex-1 group"
                data-hs-stepper-nav-item='{
              "index": 3
            }'
              >
                <span
                  class="min-w-7 min-h-7 group inline-flex items-center text-xs align-middle"
                >
                  <span
                    class="size-7 flex justify-center items-center flex-shrink-0 bg-gray-100 font-medium text-gray-800 rounded-full group-focus:bg-gray-200 hs-stepper-active:bg-blue-600 hs-stepper-active:text-white hs-stepper-success:bg-blue-600 hs-stepper-success:text-white hs-stepper-completed:bg-teal-500 hs-stepper-completed:group-focus:bg-teal-600 dark:bg-neutral-700 dark:text-white dark:group-focus:bg-gray-600 dark:hs-stepper-active:bg-blue-500 dark:hs-stepper-success:bg-blue-500 dark:hs-stepper-completed:bg-teal-500 dark:hs-stepper-completed:group-focus:bg-teal-600"
                  >
                    <span
                      class="hs-stepper-success:hidden hs-stepper-completed:hidden"
                      >3</span
                    >
                    <svg
                      class="hidden flex-shrink-0 size-3 hs-stepper-success:block"
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="3"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </span>
                  <span
                    class="ms-2 text-sm font-medium text-gray-800 dark:text-neutral-200"
                  >
                    Hoàn thành và lưu lại dữ liệu
                  </span>
                </span>
                <div
                  class="w-full h-px flex-1 bg-gray-200 group-last:hidden hs-stepper-success:bg-blue-600 hs-stepper-completed:bg-teal-600 dark:bg-neutral-700 dark:hs-stepper-success:bg-blue-600 dark:hs-stepper-completed:bg-teal-600"
                ></div>
              </li>
              <!-- End Item -->
            </ul>
            <!-- End Stepper Nav -->

            <!-- Stepper Content -->
            <div class="mt-5 sm:mt-8">
              <!-- First Content -->
              <div
                data-hs-stepper-content-item='{
              "index": 1,
              "isCompleted": true
            }'
                class="success"
                style="display: none"
              >
                <div
                  class="p-4 h-48 bg-gray-50 flex justify-center items-center border border-dashed border-gray-200 rounded-xl dark:bg-neutral-800 dark:border-neutral-700 overflow-y-auto"
                >
                  <div class="w-full h-full inline-flex items-stretch">
                    <img
                      class="object-cover w-full h-full rounded"
                      id="modal-first-img"
                    />
                    <img
                      class="object-contain w-full h-full rounded"
                      id="modal-crop-img"
                    />
                  </div>
                </div>
              </div>
              <!-- End First Content -->

              <!-- First Content -->
              <div
                data-hs-stepper-content-item='{
              "index": 2
            }'
                class="active"
              >
                <div
                  class="p-4 h-full bg-gray-50 flex justify-center items-center border border-dashed border-gray-200 rounded-xl dark:bg-neutral-800 dark:border-neutral-700 overflow-y-auto"
                >
                  <div class="w-full h-full">
                    <!-- Card Section -->
                    <div class="max-w-4xl mx-auto">
                      <!-- Card -->
                      <div
                        class="bg-white rounded-xl shadow p-4 sm:p-7 dark:bg-neutral-800"
                      >
                        <div class="mb-8">
                          <h2
                            class="text-xl font-bold text-gray-800 dark:text-neutral-200"
                          >
                            Biển số xe
                          </h2>
                        </div>

                        <form id="form-container">
                          <!-- Grid -->
                          <div
                            class="grid sm:grid-cols-12 gap-2 sm:gap-6"
                            id="form-grid"
                          ></div>
                          <!-- End Grid -->
                          <div class="mt-5 flex justify-end gap-x-2">
                            <button
                              type="button"
                              id="btnGetviolations"
                              class="py-2 px-3 inline-flex justify-end items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800"
                            >
                              Lấy lịch sử vi phạm của xe
                            </button>
                          </div>
                          <div class="mt-5 flex justify-end gap-x-2">
                            <button
                              type="button"
                              class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800"
                            >
                              Cancel
                            </button>
                            <button
                              type="button"
                              id="btnCreateOrUpdateCar"
                              class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none"
                            >
                              Save changes
                            </button>
                          </div>
                        </form>
                      </div>
                      <!-- End Card -->
                    </div>
                    <!-- End Card Section -->
                  </div>
                </div>
              </div>
              <!-- End First Content -->

              <!-- First Content -->
              <div
                data-hs-stepper-content-item='{
              "index": 3
            }'
                style="display: none"
              >
                <div
                  class="p-4 h-48 bg-gray-50 flex justify-center items-center border border-dashed border-gray-200 rounded-xl dark:bg-neutral-800 dark:border-neutral-700"
                >
                  <h3 class="text-gray-500 dark:text-neutral-500">
                    Third content
                  </h3>
                </div>
              </div>
              <!-- End First Content -->

              <!-- Final Content -->
              <div
                data-hs-stepper-content-item='{
              "isFinal": true
            }'
                style="display: none"
              >
                <div
                  class="p-4 h-48 bg-gray-50 flex justify-center items-center border border-dashed border-gray-200 rounded-xl dark:bg-neutral-800 dark:border-neutral-700"
                >
                  <h3 class="text-gray-500 dark:text-neutral-500">
                    Final content
                  </h3>
                </div>
              </div>
              <!-- End Final Content -->

              <!-- Button Group -->
              <div class="mt-5 flex justify-between items-center gap-x-2">
                <button
                  type="button"
                  class="py-2 px-3 inline-flex items-center gap-x-1 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none"
                  data-hs-stepper-back-btn=""
                >
                  <svg
                    class="flex-shrink-0 size-4"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="m15 18-6-6 6-6"></path>
                  </svg>
                  Back
                </button>
                <button
                  type="button"
                  class="py-2 px-3 inline-flex items-center gap-x-1 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none"
                  data-hs-stepper-next-btn=""
                >
                  Next
                  <svg
                    class="flex-shrink-0 size-4"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="m9 18 6-6-6-6"></path>
                  </svg>
                </button>
                <button
                  type="button"
                  class="py-2 px-3 inline-flex items-center gap-x-1 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none"
                  data-hs-stepper-finish-btn=""
                  style="display: none"
                >
                  Finish
                </button>
                <button
                  type="reset"
                  class="py-2 px-3 inline-flex items-center gap-x-1 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none"
                  data-hs-stepper-reset-btn=""
                  style="display: none"
                >
                  Reset
                </button>
              </div>
              <!-- End Button Group -->
            </div>
            <!-- End Stepper Content -->
          </div>
          <!-- End Stepper -->
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="min-h-60 flex flex-col lg:flex-row bg-white border shadow-sm rounded-xl dark:bg-neutral-900 dark:border-neutral-700 dark:shadow-neutral-700/70"
>
  <!-- LEFT INPUT -->
  <div class="relative flex md:flex-1 flex-auto flex-col p-4">
    <div class="flex flex-row justify-between items-center">
      <div class="flex items-center">
        <svg
          class="size-10 text-gray-500 dark:text-neutral-500"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="22" x2="2" y1="12" y2="12"></line>
          <path
            d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"
          ></path>
          <line x1="6" x2="6.01" y1="16" y2="16"></line>
          <line x1="10" x2="10.01" y1="16" y2="16"></line>
        </svg>

        <p class="my-2 ms-4 text-sm text-gray-800 dark:text-neutral-300">
          INPUT
        </p>
      </div>
      <button
        type="button"
        class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800 uppercase"
        id="btn_Checkin"
      >
        CHECK IN
      </button>
    </div>
    <hr class="mt-2" />
    <div class="relative my-4 flex flex-col items-center" id="video_input">
      <div class="absolute overlay-frame">
        <div class="relative" id="videoContainer">
          <img style="min-height: 367px; width: 612px; border-radius: 4px" />
          <div
            style="
              background-color: black;
              width: 90px;
              height: 1px;
              position: absolute;
              top: 20px;
              left: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 1px;
              height: 88px;
              position: absolute;
              top: 20px;
              left: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 90px;
              height: 1px;
              position: absolute;
              top: 20px;
              right: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 1px;
              height: 88px;
              position: absolute;
              top: 20px;
              right: 20px;
            "
          ></div>

          <div
            style="
              background-color: black;
              width: 90px;
              height: 1px;
              position: absolute;
              bottom: 20px;
              left: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 1px;
              height: 88px;
              position: absolute;
              bottom: 20px;
              left: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 90px;
              height: 1px;
              position: absolute;
              bottom: 20px;
              right: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 1px;
              height: 88px;
              position: absolute;
              bottom: 20px;
              right: 20px;
            "
          ></div>
          <div style="position: absolute; top: 30px; left: 30px; display: flex">
            <div
              style="
                background-color: red;
                width: 13px;
                height: 13px;
                border-radius: 100%;
              "
              id="record"
            ></div>
            <div
              style="
                color: black;
                position: absolute;
                top: -6px;
                left: 20px;
                font-family: 'Poppins', sans-serif;
              "
            >
              REC
            </div>
          </div>
          <div
            style="
              position: absolute;
              bottom: 23px;
              right: 30px;
              width: 100%;
              display: flex;
              justify-content: right;
              font-size: small;
            "
          >
            <div
              style="color: black; font-family: 'Poppins', sans-serif"
              id="time"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <div id="result_socket"></div>
  </div>
  <!--END LEFT INPUT -->
  <div
    class="border-t sm:border-t-0 sm:border-s border-gray-200 dark:border-neutral-700"
  ></div>
  <!-- RIGHT INPUT -->
  <div class="relative flex md:flex-1 flex-auto flex-col p-4">
    <div class="flex flex-row justify-between items-center">
      <div class="flex items-center">
        <svg
          class="size-10 text-gray-500 dark:text-neutral-500"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="22" x2="2" y1="12" y2="12"></line>
          <path
            d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"
          ></path>
          <line x1="6" x2="6.01" y1="16" y2="16"></line>
          <line x1="10" x2="10.01" y1="16" y2="16"></line>
        </svg>
        <p class="my-2 ms-4 text-sm text-gray-800 dark:text-neutral-300">
          OUTPUT
        </p>
      </div>
      <button
        type="button"
        class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-blue-600 text-blue-600 hover:border-blue-500 hover:text-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:border-blue-500 dark:text-blue-500 dark:hover:text-blue-400 dark:hover:border-blue-400 uppercase"
        onclick="CheckOut()"
        id="btn_CheckOut"
      >
        CHECK OUT
      </button>
    </div>

    <hr class="mt-2" />

    <div class="relative my-4 flex flex-col items-center" id="video_output">
      <div class="absolute overlay-frame">
        <div class="relative" id="videoContainer">
          <img style="min-height: 367px; width: 612px; border-radius: 4px" />
          <div
            style="
              background-color: black;
              width: 90px;
              height: 1px;
              position: absolute;
              top: 20px;
              left: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 1px;
              height: 88px;
              position: absolute;
              top: 20px;
              left: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 90px;
              height: 1px;
              position: absolute;
              top: 20px;
              right: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 1px;
              height: 88px;
              position: absolute;
              top: 20px;
              right: 20px;
            "
          ></div>

          <div
            style="
              background-color: black;
              width: 90px;
              height: 1px;
              position: absolute;
              bottom: 20px;
              left: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 1px;
              height: 88px;
              position: absolute;
              bottom: 20px;
              left: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 90px;
              height: 1px;
              position: absolute;
              bottom: 20px;
              right: 20px;
            "
          ></div>
          <div
            style="
              background-color: black;
              width: 1px;
              height: 88px;
              position: absolute;
              bottom: 20px;
              right: 20px;
            "
          ></div>
          <div style="position: absolute; top: 30px; left: 30px; display: flex">
            <div
              style="
                background-color: red;
                width: 13px;
                height: 13px;
                border-radius: 100%;
              "
              id="record"
            ></div>
            <div
              style="
                color: black;
                position: absolute;
                top: -6px;
                left: 20px;
                font-family: 'Poppins', sans-serif;
              "
            >
              REC
            </div>
          </div>
          <div
            style="
              position: absolute;
              bottom: 23px;
              right: 30px;
              width: 100%;
              display: flex;
              justify-content: right;
              font-size: small;
            "
          >
            <div
              style="color: black; font-family: 'Poppins', sans-serif"
              id="time"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <div id="result_socket_out"></div>
  </div>
  <!--END RIGHT INPUT -->
</div>
<input type="hidden" id="license_plate_val" />
<img id="snapshot" src="" alt="Snapshot" class="hidden" />
<img id="snapshot_output" src="" alt="Snapshot" class="hidden" />
{%endblock%} {%block scripts%} {{ super() }}
<!-- Định nghĩa các biến -->
<script>
  var socket = io.connect("http://127.0.0.1:5000");
  var btnCheckin = document.getElementById("btn_Checkin");
  var btnCheckOut = document.getElementById("btn_CheckOut");
  var elCheckInResult = document.getElementById("result_socket");
  var elCheckOutResult = document.getElementById("result_socket_out");
  var licensePlateDiv = document.getElementById("license_plate");
  var croppedImg = document.getElementById("cropped_image");
  var video_input = document.querySelector("#video_input");
  var video_output = document.querySelector("#video_output");
  var snapshot_output = document.getElementById("snapshot_output");
  var loading_progress = $("#process_loading");

  var text_loading = document.getElementById("text_loading");
  var formContainer = document.getElementById("form-container");
  var form_grid = document.getElementById("form-grid");
</script>
<!--Kết thúc Định nghĩa các biến -->

<!-- Setup if document Ready -->
<script>
  $(document).ready(function () {
    (async function () {
      const stepper = new HSStepper(document.querySelector("#stepper"));
      stepper.on("beforeNext", async (index) => {
        if (index === 1) {
          if ($("#license_plate_text").text().trim() === "") {
            localStorage.removeItem("car");
          }
          resetForm();
          const car = localStorage.getItem("car");
          const data = JSON.parse(car);
          if (car) {
            $("#model").val(data.model);
            $("#owner_name").val(data.owner_name);
            $("#engine_capacity").val(data.engine_capacity);
            $("#brand").val(data.brand);
            $("#vehicle_type").val(data.vehicle_type);
            $("#violations").val(data.violations);
          }
        }
      });
      stepper.on("finish", async function (index) {
        if (index === 3) {
          //gọi hàm checkin
          if ($("#license_plate_text").text().trim() === "") {
            showSwal("error", "Thất Bại", "Biển số không có sẵn !");
          } else {
            await addCheckInLog($("#license_plate_val").val(), "CHECK_IN");
            HSOverlay.close("#modal_checkin");
          }
        }
      });
    })();
    elCheckInResult.innerHTML = innerHtmlNoData(
      "Vui lòng đưa vùng chứa biển số và bấm CHECK IN"
    );
    elCheckOutResult.innerHTML = innerHtmlNoData(
      "Vui lòng đưa vùng chứa biển số và bấm CHECK OUT"
    );
    var owner_nameFieldHtml = createFormField(
      "Tên chủ sở hữu",
      "text",
      "owner_name",
      "ex: Nguyễn Văn A",
      false,
      "Tên chủ sở hữu"
    );
    var provinceFieldHtml = createFormField(
      "Tỉnh thành",
      "text",
      "province",
      "Biển số thuộc tỉnh thành",
      false
    );
    var vehicle_typeFieldHtml = createFormField(
      "Dòng xe",
      "text",
      "vehicle_type",
      "ex: SUV",
      false
    );
    var brandFieldHtml = createFormField(
      "Hãng xe",
      "text",
      "brand",
      "ex: Toyota",
      false
    );
    var modelFieldHtml = createFormField(
      "Mô hình",
      "text",
      "model",
      "ex: RAV4",
      false
    );
    var engine_capacityFieldHtml = createFormField(
      "Phân khối",
      "text",
      "engine_capacity",
      "ex: 2000cc",
      false
    );
    var violationsFieldHtml = createFormField(
      "Lịch sử vi phạm",
      "text",
      "violations",
      "ex: ",
      true
    );
    appendFormField(form_grid, owner_nameFieldHtml);
    appendFormField(form_grid, provinceFieldHtml);
    appendFormField(form_grid, vehicle_typeFieldHtml);
    appendFormField(form_grid, brandFieldHtml);
    appendFormField(form_grid, modelFieldHtml);
    appendFormField(form_grid, engine_capacityFieldHtml);
    appendFormField(form_grid, violationsFieldHtml);
  });
</script>
<!-- End Setup if document Ready -->

<!-- Định nghĩa các hàm -->
<script>
  async function addCheckInLog(license_plate, type) {
    loading_progress.removeClass("hidden");
    const time = await GetTime();
    var settings = {
      url: `/add-checkin-checkout-log?license_plate=${license_plate}`,
      method: "POST",
      timeout: 0,
      headers: {
        "Content-Type": "application/json",
      },
      data: JSON.stringify({
        time: time,
        event_type: type,
      }),
    };

    $.ajax(settings)
      .done(function (response) {
        loading_progress.addClass("hidden");
        if (response.status === 200) {
          if (type === "CHECK_IN") {
            Swal.fire({
              icon: "success",
              title: "CHECK IN THÀNH CÔNG !",
              text: response.message,
            });
          } else {
            Swal.fire({
              icon: "success",
              title: "CHECK OUT THÀNH CÔNG !",
              text: response.message,
            });
          }
        } else if (response.status === 404) {
          Swal.fire({
            icon: "error",
            title: "CHECK IN / OUT THẤT BẠI!",
            text:
              `Không tìm thấy biển số này :  ${license_plate}! ` +
              response.message,
          });
        }
      })
      .fail(function (jqXHR, textStatus, errorThrown) {
        loading_progress.addClass("hidden");
        if (jqXHR.responseJSON.status === 400) {
          if (type === "CHECK_IN") {
            Swal.fire({
              icon: "error",
              title: "CHECK IN THẤT BẠI!",
              text: `Biển số này đã Check In Vui lòng CheckOut rồi quay lại CheckIn ${jqXHR.responseJSON.message}`,
            });
          } else if (type === "CHECK_OUT") {
            Swal.fire({
              icon: "error",
              title: "CHECK OUT THẤT BẠI!",
              text: `Biển số này chưa CHECK IN không thể CheckOut ${jqXHR.responseJSON.message}`,
            });
          }
        } else {
          Swal.fire({
            icon: "error",
            title: "THẤT BẠI!",
            text: `Error ${jqXHR.responseJSON.message}`,
          });
        }

        console.log("XHR ERR", jqXHR);
      });
  }
  function resetForm() {
    $("#model").val("");
    $("#owner_name").val("");
    $("#engine_capacity").val("");
    $("#brand").val("");
    $("#violations").val("");
    $("#vehicle_type").val("");
  }
  function appendFormField(container, formFieldHtml) {
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = formFieldHtml;

    // Append each child of tempDiv to the container
    while (tempDiv.firstChild) {
      container.appendChild(tempDiv.firstChild);
    }
  }
  function createFormField(
    labelText,
    inputType,
    inputId,
    inputPlaceholder,
    isTextarea = false,
    tooltip = ""
  ) {
    if (isTextarea) {
      return `
      <div class="sm:col-span-3">
        <label
          for="${inputId}"
          class="inline-block text-sm text-gray-800 mt-2.5 dark:text-neutral-200"
        >
          ${labelText}
        </label>
      </div>

      <div class="sm:col-span-9">
        <textarea
          id="${inputId}"
          class="py-2 px-3 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600"
          rows="6"
          placeholder="${inputPlaceholder}"
        ></textarea>
      </div>
     `;
    } else {
      return `
      <div class="sm:col-span-3">
        <label
          for="${inputId}"
          class="inline-block text-sm text-gray-800 mt-2.5 dark:text-neutral-200"
        >
          ${labelText}
        </label>
        <div class="hs-tooltip inline-block">
          <button
            type="button"
            class="hs-tooltip-toggle ms-1"
          >
            <svg
              class="inline-block size-3 text-gray-400 dark:text-neutral-600"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              viewBox="0 0 16 16"
            >
              <path
                d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
              />
              <path
                d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"
              />
            </svg>
          </button>
          <span
            class="hs-tooltip-content hs-tooltip-shown:opacity-100 hs-tooltip-shown:visible opacity-0 transition-opacity inline-block absolute invisible w-40 text-center z-10 py-1 px-2 bg-gray-900 text-xs font-medium text-white rounded shadow-sm dark:bg-neutral-700"
            role="tooltip"
          >
            ${tooltip}
          </span>
        </div>
      </div>

      <div class="sm:col-span-9">
        <input
          id="${inputId}"
          type="${inputType}"
          class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600"
          placeholder="${inputPlaceholder}"
        />
      </div>

     `;
    }
  }

  // Example usage

  // Add more fields as needed
  function showLoadingAlert(title, message, timerDuration) {
    let timerInterval;

    Swal.fire({
      title: title,
      html: message,
      showConfirmButton: false,
      allowOutsideClick: false,
      willOpen: () => {
        Swal.showLoading();

        const timer = document.createElement("b");
        timerInterval = setInterval(() => {
          timer.textContent = `${Swal.getTimerLeft()}`;
        }, 100);

        // Đặt thời gian dựa trên thời gian của sự kiện Socket IO
        setTimeout(() => {
          clearInterval(timerInterval);
          Swal.close(); // Đóng cửa sổ cảnh báo khi hết thời gian
        }, timerDuration);
      },
      willClose: () => {
        clearInterval(timerInterval);
      },
      timer: timerDuration,
      timerProgressBar: true,
    });
  }

  function innerHtmlNoData(text) {
    return `
      <div class="min-h-60 flex flex-col bg-white border shadow-sm rounded-xl dark:bg-neutral-900 dark:border-neutral-700 dark:shadow-neutral-700/70">
        <div class="flex flex-auto flex-col justify-center items-center p-4 md:p-5">
          <svg
            class="size-10 text-gray-500 dark:text-neutral-500"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="22" x2="2" y1="12" y2="12"></line>
            <path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path>
            <line x1="6" x2="6.01" y1="16" y2="16"></line>
            <line x1="10" x2="10.01" y1="16" y2="16"></line>
          </svg>
          <p class="mt-2 text-sm text-gray-800 dark:text-neutral-300">${text}</p>
        </div>
      </div>`;
  }
  function innerDataSocket(data) {
    const date = new Date();
    const img_path = data.original_image;
    const crop_img_path = data.cropped_image;
    return `
      <div class="bg-white border rounded-xl shadow-sm sm:flex dark:bg-neutral-900 dark:border-neutral-700 dark:shadow-neutral-700/70 text-center">
        <div class="flex-shrink-0 relative w-full rounded-t-xl overflow-hidden pt-[40%] sm:rounded-s-xl sm:max-w-60 md:rounded-se-none md:max-w-xs">
          <img
            id="cropped_image"
            class="absolute top-0 start-0 object-contain"
            alt="Image Description"
            src="/${img_path}"
          />
        </div>
        <div class="flex flex-wrap justify-center">
          <div class="p-4 flex flex-col h-full sm:p-7">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white uppercase">
              License Plate captured
            </h3>
            <p
              class="mt-1 text-lg text-gray-500 dark:text-neutral-400"
              id="license_plate"
            >${data.license_plate.join(", ")}</p>
            <img
              id="cropped_image"
              class="size-full object-contain"
              alt="Image Description"
              src="/${crop_img_path}"
            />
            <div class="mt-5">
              <p class="text-lg text-gray-500 dark:text-neutral-500">${
                date.toLocaleDateString() + " " + date.toLocaleTimeString()
              }</p>
            </div>
          </div>
        </div>

      </div>`;
  }
  function showLoadingBtn(text) {
    return `<span
      class="animate-spin inline-block size-4 border-[3px] border-current border-t-transparent rounded-full"
      role="status"
      aria-label="loading"
    ></span>
    ${text}`;
  }
  // Function to format violation data
  function formatViolations(violations) {
    // Split the violations into lines
    const lines = violations.split("\n");

    // Format each line
    const formattedLines = lines.map((line) => {
      // Check if the line starts with a number
      if (/^\d+\s/.test(line)) {
        // Add a bullet point
        return `• ${line}`;
      } else {
        return line;
      }
    });

    // Join the formatted lines back together
    return formattedLines.join("\n");
  }
  async function GetTime() {
    const date = new Date();
    return date.toLocaleDateString() + " " + date.toLocaleTimeString();
  }
  async function create_car() {
    //localStorage.removeItem("car");
    //resetForm();
    loading_progress.removeClass("hidden");
    const date = new Date();
    try {
      const data = {
        license_plate: $("#license_plate_val").val(),
        owner_name: $("#owner_name").val(),
        vehicle_type: $("#vehicle_type").val(),
        brand: $("#brand").val(),
        model: $("#model").val(),
        engine_capacity: $("#engine_capacity").val(),
        violations: $("#violations").val(),
        original_image: $("#modal-first-img").attr("src"),
        cropped_image: $("#modal-crop-img").attr("src"),
        checkin_checkout_logs: [],
      };
      if (data.license_plate === "" || data.license_plate === null) {
        loading_progress.addClass("hidden");
        showSwal("error", "Error !", "Please enter license plate");
      } else if (data.violations === null || data.violations === "") {
        loading_progress.addClass("hidden");
        showSwal(
          "error",
          "Error !",
          "Please get violations ! Click button get violations"
        );
      } else {
        const response = await axios.post("/add-car", data);
        console.log(response); // Log response data if needed
        if (response.data.status === 200) {
          loading_progress.addClass("hidden");
          Swal.fire({
            title: "Thành công!",
            text: `Lưu dữ liệu biển số thành công | ${response.data.message}`,
            icon: "success",
          });
        } else {
          loading_progress.addClass("hidden");
          Swal.fire({
            title: "Thao tác có vấn đề ",
            text: `Lưu dữ liệu biển số không thành công | ${response.data.message}`,
            icon: "warning",
          });
        }
      }
    } catch (error) {
      loading_progress.addClass("hidden");
      console.error("Error adding car:", error);
      showToast("error", error.response.data.error, "top-end", 2000);
    }
  }

  async function updateCar(carId, carData) {
    loading_progress.removeClass("hidden");
    var settings = {
      url: `/update-car?_id=${carId}`,
      method: "PUT",
      timeout: 0,
      headers: {
        "Content-Type": "application/json",
      },
      data: JSON.stringify(carData),
    };

    $.ajax(settings)
      .done(function (response) {
        console.log(response);
        if (response.status === 200) {
          localStorage.setItem("car", JSON.stringify(response.car));
          loading_progress.addClass("hidden");
        } else {
          loading_progress.addClass("hidden");
        }
        showSwal(
          "success",
          `${response.message}`,
          `${JSON.stringify(response.car)}`
        );
      })
      .fail(function (jqXHR, textStatus) {
        loading_progress.addClass("hidden");
        showSwal("error", textStatus, jqXHR.message);
      });
  }
  async function getCar(license_plate) {
    loading_progress.removeClass("hidden");
    var settings = {
      url: `/get-car?license_plate=${license_plate}`,
      method: "GET",
      timeout: 0,
    };

    $.ajax(settings)
      .done(function (response) {
        loading_progress.addClass("hidden");
        if (response.status === 200) {
          const car = response.car;
          if (car !== null) {
            localStorage.setItem("car", JSON.stringify(car));
          }
        } else {
          if (response.status === 404) {
            showSwal("error", "Unable to", "404 neff");
          }
        }
      })
      .fail(function (jqXHR, textStatus, errorThrown) {
        loading_progress.addClass("hidden");
        if (jqXHR.status === 404) {
          localStorage.removeItem("car");
          $("#license_plate_text").html(`
            ${license_plate}
            <span class="flex absolute top-0 end-0 -mt-2 -me-2">
              <span
                class="animate-ping absolute inline-flex size-full rounded-full bg-red-400 opacity-75 dark:bg-red-600"
              ></span>
              <span
                class="relative inline-flex text-xs bg-red-500 text-white rounded-full py-0.5 px-1.5"
                id="new_license_plate"
              >
                Mới
              </span>
            </span>
            `);
        }
      });
  }
  async function fCheckViolations(license_plate) {
    loading_progress.removeClass("hidden");
    var settings = {
      url: `/check-violations?license_plate=${license_plate}`,
      method: "GET",
      timeout: 0,
    };

    $.ajax(settings)
      .done(function (response) {
        const result = JSON.parse(response);
        console.log(result);

        if (result.status === 200) {
          loading_progress.addClass("hidden");
          showSwal("success", "Thành công", `${result.message}`);
          const violationFormatted = formatViolations(result.message);
          $("#violations").val(violationFormatted);
        } else {
          if (result.status === 400) {
            showSwal("error", "Thất bại", `${result.message}`);
          }
          loading_progress.addClass("hidden");
        }
      })
      .fail(function (jqXHR, textStatus, errorThrown) {
        if (jqXHR.status === 404) {
          loading_progress.addClass("hidden");
        }
      });
  }
</script>
<!-- Kết thúc Định nghĩa các hàm -->
<!-- Định nghĩa các event -->
<script>
  $("#btnGetviolations").click(function () {
    fCheckViolations($("#license_plate_val").val());
  });
</script>
<script>
  $("#btnCreateOrUpdateCar").click(async function () {
    if ($("#new_license_plate").text().trim() === "Mới") {
      create_car();
    } else {
      const car = localStorage.getItem("car");
      const data = JSON.parse(car);
      const date = new Date();
      const updateData = {
        brand: $("#brand").val(),
        engine_capacity: $("#engine_capacity").val(),
        license_plate: $("#license_plate_val").val(),
        model: $("#model").val(),
        owner_name: $("#owner_name").val(),
        vehicle_type: $("#vehicle_type").val(),
        violations: $("#violations").val(),
        original_image: $("#modal-first-img").attr("src"),
        cropped_image: $("#modal-crop-img").attr("src"),
      };
      updateCar(data.id, updateData);
    }
  });

  $("#test").click(function () {
    HSOverlay.open("#modal_checkin");
  });
  btnCheckin.addEventListener("click", function (e) {
    // Show the modal
    takeSnapshotAndSend();
  });
  async function takeSnapshotAndSend() {
    loading_progress.removeClass("hidden");
    btnCheckin.innerHTML = showLoadingBtn("Loading");
    const videoElement = document.querySelector("#video_input video");
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;
    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    const imageURL = canvas.toDataURL("image/png");
    const imageElement = document.querySelector("#snapshot");
    if (imageElement) {
      // Replace the existing image with the new snapshot
      imageElement.src = imageURL;
    } else {
      // Create a new image element and append it to the body
      const newImageElement = new Image();
      newImageElement.id = "snapshot";
      newImageElement.src = imageURL;
      document.body.appendChild(newImageElement);
    }
    const imageb64URL = imageElement.getAttribute("src");

    socket.emit("image_data", { image_data: imageb64URL });
  }

  // Xử lý kết quả nhận diện biển số xe từ máy chủ Flask
  socket.on("license_plate", async function (data) {
    if (data) {
      loading_progress.addClass("hidden");
      btnCheckin.innerHTML = `CHECK IN`;

      if (data.status === 200) {
        console.log(data.license_plate[0]);
        $("#license_plate_val").val(data.license_plate[0]);
        $("#license_plate_text").text(data.license_plate[0]);
        $("#province").val(data.province_text);
        $("#province").attr("disabled", true);
        await getCar(data.license_plate[0]).then(() => {
          HSOverlay.open("#modal_checkin");
        });

        $("#modal-first-img").attr("src", `/${data.original_image}`);
        $("#modal-crop-img").attr("src", `/${data.cropped_image}`);
        elCheckInResult.innerHTML = innerDataSocket(data);
        /* Swal.fire({
          title: "Phát hiện biển số :" + $("#license_plate").text(),
          text: "Bạn có muốn lưu lại!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Có , Lưu!",
          cancelButtonText: "Không",
        }).then((result) => {
          if (result.isConfirmed) {
            create_car();
          }
        });
        */
      } else if (data.status === 400) {
        elCheckInResult.innerHTML = innerHtmlNoData(
          "Dữ liệu biển số không được tìm thấy !"
        );
      }
    }
  });
</script>

<script>
  async function CheckOut() {
    btnCheckOut.innerHTML = showLoadingBtn("Loading");

    const videoElement = document.querySelector("#video_output video");
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;

    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    const imageURL = canvas.toDataURL("image/png");
    const imageElement = document.querySelector("#snapshot_output");
    if (snapshot_output) {
      // Replace the existing image with the new snapshot
      snapshot_output.src = imageURL;
    } else {
      // Create a new image element and append it to the body
      const newImageElement = new Image();
      newImageElement.id = "snapshot_output";
      newImageElement.src = imageURL;
      document.body.appendChild(newImageElement);
    }
    const imageb64URL = imageElement.getAttribute("src");

    socket.emit("checkout", { image_data: imageb64URL });
  }

  socket.on("result_checkout", function (data) {
    if (data) {
      loading_progress.addClass("hidden");
      btnCheckOut.innerHTML = `CHECK OUT`;

      if (data.status === 200) {
        (async function () {
          console.log("Check out...");
          //call api.checkout
          await addCheckInLog(data.license_plate, "CHECK_OUT");
        })();
      }
    }
  });
</script>
<!-- Script to open camera -->
<script async>
  async function openCamera1() {
    // Yêu cầu truy cập camera
    const stream = await navigator.mediaDevices.getUserMedia({
      video: true,
    });
    const videoElement = document.createElement("video");
    videoElement.classList.add("video", "rounded");
    videoElement.srcObject = stream;
    const videoContainer = document.querySelector("#video_input");
    videoContainer.appendChild(videoElement);

    videoElement.play();
  }
  async function openCamera2() {
    // Yêu cầu truy cập camera
    const stream = await navigator.mediaDevices.getUserMedia({
      video: true,
    });
    const videoElement = document.createElement("video");
    videoElement.classList.add("video");
    videoElement.srcObject = stream;
    const videoContainer = document.querySelector("#video_output");
    videoContainer.appendChild(videoElement);

    videoElement.play();
  }

  // Gọi hàm mở camera khi trang web được tải
  (async function () {
    var access = false;
    try {
      await openCamera1();
      await openCamera2();
      access = true;
    } catch (error) {
      console.error("Error accessing camera:", error);
    } finally {
      if (!access) {
        video_input.children.item(0).classList.remove("absolute");
        video_output.children.item(0).classList.remove("absolute");
      }
    }
  })();
</script>

<script></script>
{%endblock%}
